---
title: "Chapter 6"
output: html_notebook
---

# Libraries

```{r}
library(magrittr)
library(dplyr)
library(plot3D)
library(gam)
library(mgcv)
```

# Simulation 1

* p = 2 and n = 200

* $X_{1}, X_{2}$ iid on [-pi, pi]

Response generated by:

$$Y = cos(X_1) + cos(X_2) + \epsilon$$

## 3D Scatterplot

```{r}
# Simulate a dataset of n=200 observations with p=2 regressors
x1 <- runif(200, min = -pi, max = pi)
x2 <- runif(200, min = -pi, max = pi)
y <- cos(x1) + cos(x2) + rnorm(200, mean = 0, sd = 0.1)
sim <- data.frame(x1, x2, y)

# Construct 3d scatterplot
scatter3D(x1, x2, y, col = "blue", pch = 19, cex = 0.5, type = "h",
          theta = 30, phi = 5, xlab = "x1", ylab = "x2", zlab = "y",
          ticktype = "detailed")
```

## Fitting Additive Model

* s() stands for using spline regression to construct

```{r}
sim.gam <- gam(y ~ s(x1) + s(x2), data = sim)
summary(sim.gam)
```

```{r}
sim.gam$coefficients
```


* Both non linear and linear terms are significant

* Fitted model is hence:

$$\hat{Y} = 0.06 + 0.087X_1-0.02X_2+ \hat{g_1}(X_1) + \hat{g_2}(X_2) $$

## Partial Prediction Plots

```{r}
# Construct partial prediction plots
layout(matrix(1:2, c(1,2), byrow = TRUE))
plot(sim.gam)
```


* For first plot, when X2 is fixed, Y and X1 are related in such a way
* For second plot, when X1 is fixed, Y and X2 are related in such a way


## 3D Surface Plots

```{r}
# Create grid matrices for fitted plots
xgrid <- seq(from = -pi, to = pi, by = 0.1)
x1x2grid <- data.frame(expand.grid(x1 = xgrid, x2 = xgrid))
M <- mesh(xgrid, xgrid)

# Construct 3D surface plot of fitted model
pred <- predict(sim.gam, newdata = x1x2grid)
z <- matrix(pred, nrow = length(xgrid))
surf3D(M$x, M$y, z, colvar = z, theta = 30, phi = 5, bty = "f",
       border = "black", xlab = "x1", ylab = "x2", zlab = "y", 
       ticktype = "detailed", main="Additive Model")

# Construct 3D surface plot of true model
ztrue = cos(M$x) + cos(M$y)
surf3D(M$x, M$y, ztrue, colvar = z, theta = 30, phi = 5, bty = "f",
       border = "black", xlab = "x1", ylab = "x2", zlab = "y", 
       ticktype = "detailed", main="True Model")
```



# Simulation 2

* $X_1, X_2, X_3, X_4$ on [-2.5, 2.5]

Component functions:

* $g_1(X_1) = -sin(2X_1)$

* $g_2(X_2) = X^2_2 - E(X^2_2)$

* $g_3(X_3) = X_3$

* $g_4(X_4) = e^{-X_4} - E(e^{-X_4})$

```{r}
# Simulate a dataset of n=75 observations with p=4 regressors
x1 <- runif(75, min = -2.5, max = 2.5)
g1 <- -sin(x1)
x2 <- runif(75, min = -2.5, max = 2.5)
g2 <- x2*x2 - 25/12
x3 <- runif(75, min = -2.5, max = 2.5)
g3 <- x3
x4 <- runif(75, min = -2.5, max = 2.5)
g4 <- exp(-x4)-(exp(2.5)-exp(-2.5))/5
y <- g1 + g2 + g3 + g4 + rnorm(75, mean = 0, sd = 1)
sim <- data.frame(x1, x2, x3, x4, y)

# Fit additive model with Gaussian response
sim.gam <- gam(y ~ s(x1) + s(x2) + s(x3) + s(x4), data = sim)
summary(sim.gam)

# Construct partial prediction plots
layout(matrix(1:4, c(2,2), byrow = TRUE))
plot(sim.gam, se = TRUE)
```


# Boston Housing Price Data

* Using `mgcv` library

* Does not separate the linear and nonlinear part

* Use this package because solely care about the nonlinear part


```{r}
# Read Boston Housing Price Data
raw.bhd <-read.csv(file="/Users/jasonchan/MSTAT/STAT6014_Advanced_Stat_Model/Lecture codes/R codes and data for Chapter 6 examples-20200202/BostonHouse.csv", header=TRUE,sep=",")

# Create dataset with log-transformed regressors
bhd <- log(raw.bhd[,1:10])
colnames(bhd) <- paste0("x",1:10)
bhd$medv <- raw.bhd$medv

head(bhd)
```

## Model 1, All non linear (Full Model)

```{r}
bhd.gam1 <- gam(medv ~ s(x1) + s(x2) + s(x3) + s(x4) + s(x5)
                + s(x6) + s(x7) + s(x8) + s(x9) + s(x10), data = bhd)
summary(bhd.gam1)
```

### Partial Plot

```{r}
# Construct fit plot for each component
layout(matrix(c(1:10), c(2,5), byrow = TRUE))
plot(bhd.gam1, se = TRUE, shade = TRUE)
```

From the model summary and partial plots, the following improvements were identified:

* Remove x5 due to non significance
* x8 and x9 as linear only


## Model 2, Improved (Reduced Model)

```{r}
# Fit partial linear additive model with some linear components
bhd.gam2 <- gam(medv ~ s(x1) + s(x2) + s(x3) + s(x4) + s(x6)
                + s(x7) + x8 + x9 + s(x10), data = bhd)

summary(bhd.gam2)
```

## Deviance Test

* Compare both model's deviance


```{r}
# Compare two models using Deviance test
anova(bhd.gam1, bhd.gam2, test = "Chisq")
```

* Deviance of model 2 is not significantly different from model 1
* Accept model 2 as final model

## Final Model Partial Fit Plot

```{r}
# Construct fit plot for reduced model
plot(bhd.gam2, pages = 1, se = TRUE, shade = TRUE)
```


Final model is then fitted as:


$$\hat{Y} = 60.36 - 13.87X_8 + 0.4338X_9 + \hat{g_1}(X_1)+...$$

where the gs are the non parametric components.


# Mine Fractures Data Revisited

* Past parametric models only assumes that the $log(\mu)$ is linearly related to the predictors

* Appling **GAPLM** allows more flexibility in non linear relationships between $log(\mu)$ and the predictors


```{r}
mine <- read.csv("/Users/jasonchan/MSTAT/STAT6014_Advanced_Stat_Model/data/mine.csv")

head(mine)
```

## Full Model

* Fit all additive 

```{r}
mine.gam <- gam(y ~ s(x1) + s(x2, k = 9) + s(x3) + s(x4), 
                family = poisson, data = mine)

```

* Need to add k = 9 as number of unique values is less than 10, which is the starting number of spline basis

```{r}
unique(mine$x2)
```

### Summary and Partial Plot

```{r}
summary(mine.gam)
```

* Using `mgcv` package, only concerned about the nonlinear part

```{r}
# Construct fit plots for each component
plot(mine.gam, pages = 1, se = TRUE, shade = TRUE)
```

* x1 and x3 are not significant based on summary
* x1 and x2 shows non linear relationships
* x4 shows linear relationship

Hence the following shall be done:

* Remove x1 and x3
* Make x4 linear


## Reduced Model

```{r}
mine.gam2 <- gam(y ~ s(x2, k = 9) + x4, family = poisson, data = mine)

```

### Summary and Partial Plots

```{r}
summary(mine.gam2)
```

Final model is fitted as:

$$log(\hat{\mu}) = 0.66 - 0.02979X_4+ \hat{g}(X_2)$$

```{r}
# Construct fit plots for reduced model
plot(mine.gam2, se = TRUE, shade = TRUE)
```


## Deviance Test

```{r}
# Compare two models using Deviance test
anova(mine.gam, mine.gam2, test = "Chisq")
```

* Reduced model deviance is not significantly different from full model.